<div class="grid">
    <div class="col-12">
        <p-toolbar styleClass="mb-2">
            <div class="">
                <h3>Sản phẩm</h3>
                <p-breadcrumb [model]="items"></p-breadcrumb>
            </div>
            <ng-template pTemplate="right">
                <button
                    pButton
                    pRipple
                    [routerLink]="['/products/create-product']"
                    icon="pi pi-plus"
                    label="Thêm sản phẩm"
                ></button>
            </ng-template>
        </p-toolbar>
        <div
            class="flex flex-column gap-3 align-items-end md:flex-row md:"
        >
            <div class="flex flex-column">
                <label
                    for="email1"
                    class="block text-900 text-large font-weight mb-2"
                    >Tìm kiếm theo sản phẩm:</label
                >
                <span class="block mt-2 md:mt-0 p-input-icon-left">
                    <i class="pi pi-search"></i>
                    <input
                        pInputText
                        type="text"
                        [(ngModel)]="
                            this.optionsFillerProduct.KeyWord
                        "
                        placeholder="Tìm kiếm theo tên/SKU sản phẩm"
                        style="width: 350px"
                        class="sm:"
                    />
                </span>
            </div>
            <div class="flex flex-column">
                <label
                    for="email1"
                    class="block text-900 text-large font-weight mb-2"
                    >Danh mục:</label
                >
                <div
                    class="flex justify-content-center category-select"
                >
                    <p-treeSelect
                        (onClear)="onClear()"
                        optionLabel="label"
                        [showClear]="true"
                        class="md:w-20rem w-full"
                        containerStyleClass="w-full"
                        [(ngModel)]="selectedNodes"
                        [options]="treeCategory"
                        placeholder="Chọn danh mục"
                        [filter]="true"
                        [filterInputAutoFocus]="true"
                    >
                        <ng-template let-node pTemplate="default">
                            <span>{{ node.name }}</span>
                        </ng-template>
                    </p-treeSelect>
                </div>
            </div>
            <div class="flex flex-column">
                <label
                    for="email1"
                    class="block text-900 text-large font-weight mb-2"
                    >Khoảng giá:</label
                >
                <div class="flex flex-row align-items-center gap-2">
                    <p-inputNumber
                        (blur)="checkStartPriceValue()"
                        [(ngModel)]="
                            this.optionsFillerProduct.StartPrice
                        "
                        mode="decimal"
                        placeholder="Từ:"
                        inputId="minmax-buttons"
                        [min]="0"
                        [max]="10000000"
                    />
                    -
                    <p-inputNumber
                        (blur)="checkEndPriceValue()"
                        [(ngModel)]="
                            this.optionsFillerProduct.EndPrice
                        "
                        mode="decimal"
                        placeholder="Đến:"
                        inputId="minmax-buttons"
                        [min]="0"
                        [max]="10000000"
                    />
                </div>
            </div>
            <div class="flex flex-column">
                <label
                    for="email1"
                    class="block text-900 text-large font-weight mb-2"
                    >Trạng thái:</label
                >
                <p-dropdown
                    [options]="this.optionsStatus"
                    [(ngModel)]="this.statusFilter"
                    optionLabel="name"
                    [showClear]="true"
                    placeholder="Trạng thái"
                >
                </p-dropdown>
            </div>
            <button
                pButton
                pRipple
                label="Lọc"
                (click)="EvenFilter()"
            ></button>
        </div>
        <div class="row section-main" style="margin-top: -26px">
            <div class="row section-main-product card">
              <p-table
                [value]="products"
                [rows]="5"
                [showCurrentPageReport]="true"
                currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                [rowsPerPageOptions]="[10, 25, 50]"
                styleClass="p-datatable-striped"
              >
                <ng-template pTemplate="header">
                  <tr style="height: 60px" class="n-title-head">
                    <th style="width: 5%; padding-left: 20px">
                      <p-checkbox
                        [(ngModel)]="checked"
                        [binary]="true"
                        inputId="binary"
                      ></p-checkbox>
                    </th>
                    <th style="width: 6%">Ảnh</th>
                    <th style="width: 17%">Sản phẩm</th>
                    <th style="width: 12%">SKU</th>
                    <th style="width: 12%">Phân loại</th>
                    <th style="width: 10%; text-align: right">Giá bán</th>
                    <th style="width: 7%; text-align: right">Kho</th>
                    <th style="width: 7%; text-align: right">Đã bán</th>
                    <th style="width: 13%; text-align: center">Trạng thái</th>
                    <th style="width: 16%; text-align: center">Thao tác</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product class="row">
                  <tr
                    style="
                      border-bottom: 1px solid #d9d9d9;
                      height: 100%;
                      overflow: visible;
                      position: relative;
                    "
                  >
                    <td style="padding-left: 20px">
                      <p-checkbox [binary]="true" inputId="binary"></p-checkbox>
                    </td>
                    <td class="n-image-product">
                      <img [src]="imageUrl+ '/api/files/images/'  + (product.productImages[0] ? product.productImages[0].link : 'no-image.png')" />
                    </td>
                    <td>{{ product.name }}</td>
                    <td>
                      <p
                        style="margin: 15px 0; height: 23px"
                        *ngFor="
                          let variant of this.showAllVariants.get(product.id) === 0 ||
                          this.showAllVariants.get(product.id) === 2
                            ? product.productVariants
                            : product.productVariants.slice(0, 3)
                        "
                      >
                        {{ variant.sku }}
                      </p>
                      <p *ngIf="product.productVariants.length === 0">
                        {{ product.sku }}
                      </p>
                    </td>
                    <td>
                      <p
                        style="margin: 15px 0; height: 23px"
                        *ngFor="
                          let variant of this.showAllVariants.get(product.id) === 0 ||
                          this.showAllVariants.get(product.id) === 2
                            ? product.productVariants
                            : product.productVariants.slice(0, 3)
                        "
                      >
                        {{ variant.valuePropeties1 }} , {{ variant.valuePropeties2 }}
                      </p>
                    </td>
                    <td class="price-product">
                      <p
                        style="margin: 15px 0; height: 23px"
                        *ngFor="
                          let variant of this.showAllVariants.get(product.id) === 0 ||
                          this.showAllVariants.get(product.id) === 2
                            ? product.productVariants
                            : product.productVariants.slice(0, 3)
                        "
                      >
                        {{
                          variant.price.toLocaleString("vi-VN", {
                            style: "currency",
                            currency: "VND"
                          })
                        }}
                      </p>
                      <p *ngIf="product.productVariants.length === 0">
                        {{
                          product.price.toLocaleString("vi-VN", {
                            style: "currency",
                            currency: "VND"
                          })
                        }}
                      </p>
                    </td>
                    <td class="quantity-product">
                      <p
                        style="margin: 15px 0; height: 23px"
                        *ngFor="
                          let variant of this.showAllVariants.get(product.id) === 0 ||
                          this.showAllVariants.get(product.id) === 2
                            ? product.productVariants
                            : product.productVariants.slice(0, 3)
                        "
                      >
                        {{
                          variant.quantity >= 1000
                            ? (variant.quantity / 1000)
                            : variant.quantity
                        }}
                      </p>
                      <p *ngIf="product.productVariants.length === 0">
                        {{
                          product.totalQuantity >= 1000
                            ? (product.totalQuantity / 1000)
                            : product.totalQuantity
                        }}
                      </p>
                    </td>
                    <td class="sellcounts-product">
                      <p>
                        {{
                          product.productVariants.length === 0
                            ? product.sellCounts
                            : totalSellCount(product.productVariants)
                        }}
                      </p>
                    </td>
                    <td
                      class="n-product-status"
                      style="
                        padding-left: 10px;
                        border-bottom: none;
                        border-left: none;
                        border-right: none;
                      "
                    >
                      <div
                        *ngFor="
                          let variant of this.showAllVariants.get(product.id) === 0 ||
                          this.showAllVariants.get(product.id) === 2
                            ? product.productVariants
                            : product.productVariants.slice(0, 3)
                        "
                        style="
                          margin: 15px 0;
                          width: 90%;
                          height: 23px;
                          border: 1px solid #d9d9d9;
                          border-radius: 15px;
                          text-align: center;
                          background-color: red;
                        "
                        [style.background-color]="
                          variant.quantity === 0
                            ? '#E24343'
                            : product.status === 1
                            ? '#57f298'
                            : '#DCDCDC'
                        "
                      >
                        {{
                          variant.quantity === 0
                            ? "Hết hàng"
                            : product.status === 1
                            ? "Hoạt động"
                            : "Ẩn"
                        }}
                      </div>
                      <div
                        *ngIf="product.productVariants.length === 0"
                        style="
                          margin: 15px 0;
                          width: 90%;
                          height: 23px;
                          border: 1px solid #d9d9d9;
                          border-radius: 15px;
                          text-align: center;
                          background-color: red;
                        "
                        [style.background-color]="
                          product.totalQuantity === 0
                            ? '#f23939'
                            : product.status === 1
                            ? '#57f298'
                            : '#d9d9d9'
                        "
                      >
                        {{
                          product.totalQuantity === 0
                            ? "Hết hàng"
                            : product.status === 1
                            ? "Hoạt động"
                            : "Ẩn"
                        }}
                      </div>
                    </td>
      
                    <td class="actions">
                      <!-- [routerLink]="['/admin/quanlysanpham/themsanpham']" -->
                      <a
                        [routerLink]="['/admin/quanlysanpham/suasanpham', product.id]"
                      >
                        <p>Cập nhật</p>
                      </a>
                      <p
                        style="margin: 5px 0; text-align: center; cursor: pointer"
                        (click)="ClickChangeStatus($event, product)"
                      >
                        {{ product.status !== 1 ? "Hoạt động" : "Ẩn" }}
                      </p>
                      <p
                        style="margin-top: 5px"
                        (click)="openDiaLogDelete($event, product)"
                      >
                        Xóa
                      </p>
                    </td>
                  </tr>
                  <tr style="position: relative; height: 15px">
                    <button
                      style="
                        border: none;
                        background-color: #fff;
                        position: absolute;
                        top: -10px;
                        left: 40%;
                        width: 200px;
                        z-index: 1;
                        color: #626161;
                      "
                      class="col-lg-12"
                      [style.display]="
                        this.showAllVariants.get(product.id) === 0 ? 'hide' : 'block'
                      "
                      (click)="toggleShowAllVariants(product.id)"
                    >
                      {{
                        this.showAllVariants.get(product.id) === 1
                          ? "Xem thêm " +
                            (product.productVariants.length - 3) +
                            " sản phẩm"
                          : this.showAllVariants.get(product.id) === 2
                          ? "Thu gọn " +
                            (product.productVariants.length - 3) +
                            " sản phẩm"
                          : ""
                      }}
                    </button>
                  </tr>
                </ng-template>
      
                <ng-template pTemplate="paginatorleft">
                  <p-button
                    type="button"
                    icon="pi pi-plus"
                    styleClass="p-button-text"
                  ></p-button>
                </ng-template>
                <ng-template pTemplate="paginatorright">
                  <p-button
                    type="button"
                    icon="pi pi-cloud"
                    styleClass="p-button-text"
                  ></p-button>
                </ng-template>
              </p-table>
              <div class="paginator">
                <p-paginator
                  [rows]="this.pageSize"
                  [totalRecords]="this.totalRecords > 0 ? this.totalRecords : 1"
                  [rowsPerPageOptions]="[30, 20, 10]"
                  (onPageChange)="onPageChange($event)"
                ></p-paginator>
              </div>
            </div>
          </div>
    </div>
</div>
